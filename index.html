<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RM Volley - Dashboard</title>
    
    <!-- SheetJS library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js for data visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --secondary: #00D4FF;
            --success: #00C853;
            --warning: #FFB300;
            --danger: #FF3D00;
            --text-primary: #1A1A1A;
            --text-secondary: #6B6B6B;
            --text-tertiary: #9E9E9E;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --bg-tertiary: #ECEFF1;
            --border: #E0E0E0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .header-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Filters */
        .filters {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        /* Team Cards */
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .team-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .team-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
        }

        .team-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .team-category {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-badge {
            font-size: 2rem;
        }

        .team-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .stat-box-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-box-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .win-rate-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .win-rate-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 999px;
            transition: width 0.6s ease;
        }

        .win-rate-label {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }

        .win-rate-label span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Matches Section */
        .section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.25rem;
            border-radius: var(--radius-sm);
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--bg-primary);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* Match Cards */
        .matches-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .match-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .match-card:hover {
            box-shadow: var(--shadow-md);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .match-meta {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .match-date {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .match-day {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .match-month {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .match-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .match-championship {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .match-time {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .match-status {
            padding: 0.375rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-played {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
        }

        .status-upcoming {
            background: rgba(0, 102, 255, 0.1);
            color: var(--primary);
        }

        .status-unofficial {
            background: rgba(255, 179, 0, 0.1);
            color: var(--warning);
        }

        .match-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .team {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .team.away {
            flex-direction: row-reverse;
            text-align: right;
        }

        .team-logo {
            width: 48px;
            height: 48px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .team.rm .team-logo {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .team-details {
            flex: 1;
        }

        .team-name-match {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .score {
            text-align: center;
        }

        .score-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .score-separator {
            color: var(--text-tertiary);
            margin: 0 0.5rem;
        }

        .winner .score-value {
            color: var(--success);
        }

        .sets-detail {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .set-score {
            padding: 0.375rem 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .match-venue {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .chart-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header-content {
                padding: 0 1rem;
            }

            .header-stats {
                display: none;
            }

            .teams-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .match-teams {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .score {
                order: -1;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">RM</div>
                <div class="logo-text">
                    <h1>RM Volley</h1>
                    <p>Dashboard Prestazioni</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalTeams">6</div>
                    <div class="stat-label">Squadre</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalMatches">0</div>
                    <div class="stat-label">Partite</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="winRate">0%</div>
                    <div class="stat-label">Vittorie</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Caricamento dati...</p>
        </div>

        <!-- Main Content -->
        <div id="content" style="display: none;">
            <!-- Filters -->
            <div class="filters">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Squadra</label>
                        <select id="filterTeam">
                            <option value="">Tutte le squadre</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Campionato</label>
                        <select id="filterChampionship">
                            <option value="">Tutti i campionati</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Stato</label>
                        <select id="filterStatus">
                            <option value="">Tutti gli stati</option>
                            <option value="gara omologata">Completate</option>
                            <option value="risultato ufficioso">Non ufficiali</option>
                            <option value="da disputare">Da disputare</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Cerca</label>
                        <input type="text" id="searchInput" placeholder="Cerca squadra o impianto...">
                    </div>
                </div>
            </div>

            <!-- Teams Overview -->
            <section class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Panoramica Squadre</h2>
                        <p class="section-subtitle">Performance di tutte le squadre RM Volley</p>
                    </div>
                </div>
                <div class="teams-grid" id="teamsGrid"></div>
            </section>

            <!-- Matches Section -->
            <section class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Calendario Partite</h2>
                        <p class="section-subtitle" id="matchesSubtitle">Tutte le partite</p>
                    </div>
                    <div class="view-toggle">
                        <button class="toggle-btn active" data-view="all">Tutte</button>
                        <button class="toggle-btn" data-view="played">Giocate</button>
                        <button class="toggle-btn" data-view="upcoming">Prossime</button>
                    </div>
                </div>
                <div class="matches-list" id="matchesList"></div>
            </section>

            <!-- Statistics -->
            <section class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Statistiche</h2>
                        <p class="section-subtitle">Analisi delle performance</p>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Vittorie per Squadra</h3>
                        <div class="chart-container">
                            <canvas id="winsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Percentuale Vittorie</h3>
                        <div class="chart-container">
                            <canvas id="winRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Global state
        let allMatches = [];
        let filteredMatches = [];
        let teamsData = {};
        let currentView = 'all';

        // Load Excel file
        async function loadExcelFile() {
            try {
                const response = await fetch('Gare.xls');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(firstSheet);
                
                allMatches = data;
                processData();
                renderAll();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error loading Excel file:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <h3>Errore nel caricamento dei dati</h3>
                    <p>Assicurati che il file Gare.xls sia nella stessa cartella del file HTML</p>
                `;
            }
        }

        // Process data and calculate statistics
        function processData() {
            teamsData = {};
            const rmTeams = new Set();

            // Helper to identify RM teams (handles 'RMVOLLEY' and 'RM VOLLEY' variants)
            function isRmTeam(name) {
                if (!name) return false;
                const normalized = String(name).toUpperCase().replace(/\s+/g, ' ');
                return /RM\s*VOLLEY/.test(normalized) || /RMVOLLEY/.test(normalized);
            }

            // Find all RM Volley teams
            allMatches.forEach(match => {
                const home = match.SquadraCasa;
                const away = match.SquadraOspite;

                if (isRmTeam(home)) rmTeams.add(home);
                if (isRmTeam(away)) rmTeams.add(away);
            });

            // Initialize team data
            rmTeams.forEach(team => {
                teamsData[team] = {
                    name: team,
                    played: 0,
                    wins: 0,
                    losses: 0,
                    totalMatches: 0,
                    category: getCategory(team),
                    matches: []
                };
            });

            // Calculate statistics
            allMatches.forEach(match => {
                const home = match.SquadraCasa;
                const away = match.SquadraOspite;
                const result = match.Risultato;
                const isRmHome = isRmTeam(home);
                const isRmAway = isRmTeam(away);

                if (isRmHome) {
                    teamsData[home].totalMatches++;
                    teamsData[home].matches.push(match);
                    
                    if (result && result.includes('-')) {
                        const [homeSets, awaySets] = result.split('-').map(s => parseInt(s.trim()));
                        teamsData[home].played++;
                        if (homeSets > awaySets) {
                            teamsData[home].wins++;
                        } else {
                            teamsData[home].losses++;
                        }
                    }
                }

                if (isRmAway) {
                    teamsData[away].totalMatches++;
                    teamsData[away].matches.push(match);
                    
                    if (result && result.includes('-')) {
                        const [homeSets, awaySets] = result.split('-').map(s => parseInt(s.trim()));
                        teamsData[away].played++;
                        if (awaySets > homeSets) {
                            teamsData[away].wins++;
                        } else {
                            teamsData[away].losses++;
                        }
                    }
                }
            });

            // Update header stats
            const totalPlayed = Object.values(teamsData).reduce((sum, team) => sum + team.played, 0);
            const totalWins = Object.values(teamsData).reduce((sum, team) => sum + team.wins, 0);
            const overallWinRate = totalPlayed > 0 ? Math.round((totalWins / totalPlayed) * 100) : 0;

            document.getElementById('totalMatches').textContent = allMatches.length;
            document.getElementById('winRate').textContent = overallWinRate + '%';
            // Update total teams count in header
            document.getElementById('totalTeams').textContent = Object.keys(teamsData).length;

            // Populate filters
            populateFilters();
        }

        // Get category from team name
        function getCategory(teamName) {
            const num = teamName.match(/#(\d+)/)?.[1];
            const categories = {
                '2': 'Seconda Divisione Femminile',
                '13': 'Under 14 Femminile',
                '14': 'Under 14 Femminile',
                '15': 'Under 14 Femminile',
                '16': 'Under 16 Femminile',
                '18': 'Under 18 Femminile'
            };
            return categories[num] || 'Sconosciuto';
        }

        // Get team badge emoji
        function getTeamBadge(wins, losses) {
            if (wins === 0 && losses === 0) return '‚è≥';
            const winRate = wins / (wins + losses);
            if (winRate === 1) return 'üî•';
            if (winRate >= 0.8) return '‚≠ê';
            if (winRate >= 0.6) return '‚úÖ';
            if (winRate >= 0.4) return 'üìä';
            return '‚ö†Ô∏è';
        }

        // Populate filter dropdowns
        function populateFilters() {
            const teams = [...new Set(Object.keys(teamsData))].sort();
            const championships = [...new Set(allMatches.map(m => m.Campionato))].filter(Boolean).sort();

            const teamSelect = document.getElementById('filterTeam');
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });

            const champSelect = document.getElementById('filterChampionship');
            championships.forEach(champ => {
                const option = document.createElement('option');
                option.value = champ;
                option.textContent = champ;
                champSelect.appendChild(option);
            });
        }

        // Render all components
        function renderAll() {
            applyFilters();
            renderTeams();
            renderMatches();
            renderCharts();
        }

        // Apply filters
        function applyFilters() {
            const teamFilter = document.getElementById('filterTeam').value;
            const champFilter = document.getElementById('filterChampionship').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredMatches = allMatches.filter(match => {
                const matchTeam = teamFilter ? 
                    (match.SquadraCasa === teamFilter || match.SquadraOspite === teamFilter) : true;
                const matchChamp = champFilter ? match.Campionato === champFilter : true;
                const matchStatus = statusFilter ? match.StatoDescrizione === statusFilter : true;
                const matchSearch = searchTerm ? 
                    (match.SquadraCasa?.toLowerCase().includes(searchTerm) || 
                     match.SquadraOspite?.toLowerCase().includes(searchTerm) ||
                     match.Impianto?.toLowerCase().includes(searchTerm)) : true;

                return matchTeam && matchChamp && matchStatus && matchSearch;
            });

            // Apply view filter
            if (currentView === 'played') {
                filteredMatches = filteredMatches.filter(m => 
                    m.StatoDescrizione === 'gara omologata' || m.StatoDescrizione === 'risultato ufficioso'
                );
            } else if (currentView === 'upcoming') {
                filteredMatches = filteredMatches.filter(m => m.StatoDescrizione === 'da disputare');
            }

            document.getElementById('matchesSubtitle').textContent = 
                `${filteredMatches.length} partite trovate`;
        }

        // Render team cards
        function renderTeams() {
            const grid = document.getElementById('teamsGrid');
            grid.innerHTML = '';

            Object.values(teamsData).sort((a, b) => {
                const rateA = a.played > 0 ? a.wins / a.played : 0;
                const rateB = b.played > 0 ? b.wins / b.played : 0;
                return rateB - rateA;
            }).forEach(team => {
                const winRate = team.played > 0 ? Math.round((team.wins / team.played) * 100) : 0;
                const badge = getTeamBadge(team.wins, team.losses);
                const toPlay = team.totalMatches - team.played;

                const card = document.createElement('div');
                card.className = 'team-card';
                card.innerHTML = `
                    <div class="team-header">
                        <div>
                            <div class="team-name">${team.name}</div>
                            <div class="team-category">${team.category}</div>
                        </div>
                        <div class="team-badge">${badge}</div>
                    </div>
                    <div class="team-stats">
                        <div class="stat-box">
                            <div class="stat-box-value">${team.wins}</div>
                            <div class="stat-box-label">Vittorie</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${team.losses}</div>
                            <div class="stat-box-label">Sconfitte</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">${toPlay}</div>
                            <div class="stat-box-label">Da giocare</div>
                        </div>
                    </div>
                    <div class="win-rate-bar">
                        <div class="win-rate-fill" style="width: ${winRate}%"></div>
                    </div>
                    <div class="win-rate-label">
                        <span>Tasso di vittoria</span>
                        <span><strong>${winRate}%</strong></span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Render matches
        function renderMatches() {
            const list = document.getElementById('matchesList');
            list.innerHTML = '';

            if (filteredMatches.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üèê</div>
                        <h3>Nessuna partita trovata</h3>
                        <p>Prova a modificare i filtri di ricerca</p>
                    </div>
                `;
                return;
            }

            // Sort by date (most recent first for played, soonest for upcoming)
            const sorted = [...filteredMatches].sort((a, b) => {
                const dateA = parseDate(a.Data);
                const dateB = parseDate(b.Data);
                if (currentView === 'upcoming') {
                    return dateA - dateB;
                }
                return dateB - dateA;
            });

            sorted.forEach(match => {
                const card = createMatchCard(match);
                list.appendChild(card);
            });
        }

        // Create match card
        function createMatchCard(match) {
            const card = document.createElement('div');
            card.className = 'match-card';

            const date = parseDate(match.Data);
            const day = date.getDate();
            const month = date.toLocaleDateString('it-IT', { month: 'short' });

            const isRmHome = match.SquadraCasa?.includes('RMVOLLEY');
            const isRmAway = match.SquadraOspite?.includes('RMVOLLEY');

            let statusClass = 'status-upcoming';
            let statusText = match.StatoDescrizione || 'Da disputare';
            
            if (match.StatoDescrizione === 'gara omologata') {
                statusClass = 'status-played';
                statusText = 'Completata';
            } else if (match.StatoDescrizione === 'risultato ufficioso') {
                statusClass = 'status-unofficial';
                statusText = 'Non ufficiale';
            }

            let scoreHtml = '<div class="score"><span class="score-value">VS</span></div>';
            let setsHtml = '';

            if (match.Risultato && match.Risultato.includes('-')) {
                const [homeSets, awaySets] = match.Risultato.split('-').map(s => parseInt(s.trim()));
                const homeWin = homeSets > awaySets;
                const awayWin = awaySets > homeSets;

                scoreHtml = `
                    <div class="score ${homeWin ? 'winner' : ''}">
                        <span class="score-value">${homeSets}</span>
                        <span class="score-separator">-</span>
                        <span class="score-value ${awayWin ? 'winner' : ''}">${awaySets}</span>
                    </div>
                `;

                if (match.Parziali) {
                    const sets = match.Parziali.split(' ').filter(s => s.trim());
                    setsHtml = `
                        <div class="sets-detail">
                            ${sets.map(set => `<span class="set-score">${set}</span>`).join('')}
                        </div>
                    `;
                }
            }

            card.innerHTML = `
                <div class="match-header">
                    <div class="match-meta">
                        <div class="match-date">
                            <div class="match-day">${day}</div>
                            <div class="match-month">${month}</div>
                        </div>
                        <div class="match-info">
                            <div class="match-championship">${match.Campionato || 'N/A'}</div>
                            <div class="match-time">‚è∞ ${match.Ora || 'TBD'}</div>
                        </div>
                    </div>
                    <div class="match-status ${statusClass}">${statusText}</div>
                </div>
                <div class="match-teams">
                    <div class="team home ${isRmHome ? 'rm' : ''}">
                        <div class="team-logo">${isRmHome ? 'RM' : getTeamInitials(match.SquadraCasa)}</div>
                        <div class="team-details">
                            <div class="team-name-match">${match.SquadraCasa || 'TBD'}</div>
                        </div>
                    </div>
                    ${scoreHtml}
                    <div class="team away ${isRmAway ? 'rm' : ''}">
                        <div class="team-logo">${isRmAway ? 'RM' : getTeamInitials(match.SquadraOspite)}</div>
                        <div class="team-details">
                            <div class="team-name-match">${match.SquadraOspite || 'TBD'}</div>
                        </div>
                    </div>
                </div>
                ${setsHtml}
                <div class="match-venue">
                    üìç ${match.Impianto || 'Impianto TBD'}
                </div>
            `;

            return card;
        }

        // Get team initials
        function getTeamInitials(teamName) {
            if (!teamName) return '?';
            const words = teamName.split(' ').filter(w => w.length > 2);
            if (words.length >= 2) {
                return words[0][0] + words[1][0];
            }
            return teamName.substring(0, 2).toUpperCase();
        }

        // Parse date string
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }

        // Render charts
        function renderCharts() {
            renderWinsChart();
            renderWinRateChart();
        }

        // Render wins chart
        function renderWinsChart() {
            const ctx = document.getElementById('winsChart');
            const teams = Object.values(teamsData).sort((a, b) => b.wins - a.wins);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: teams.map(t => t.name),
                    datasets: [{
                        label: 'Vittorie',
                        data: teams.map(t => t.wins),
                        backgroundColor: 'rgba(0, 102, 255, 0.8)',
                        borderRadius: 8
                    }, {
                        label: 'Sconfitte',
                        data: teams.map(t => t.losses),
                        backgroundColor: 'rgba(255, 61, 0, 0.6)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Render win rate chart
        function renderWinRateChart() {
            const ctx = document.getElementById('winRateChart');
            const teams = Object.values(teamsData).filter(t => t.played > 0);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: teams.map(t => t.name),
                    datasets: [{
                        data: teams.map(t => t.played > 0 ? Math.round((t.wins / t.played) * 100) : 0),
                        backgroundColor: [
                            'rgba(0, 102, 255, 0.8)',
                            'rgba(0, 212, 255, 0.8)',
                            'rgba(0, 200, 83, 0.8)',
                            'rgba(255, 179, 0, 0.8)',
                            'rgba(255, 61, 0, 0.8)',
                            'rgba(156, 39, 176, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('filterTeam').addEventListener('change', renderAll);
        document.getElementById('filterChampionship').addEventListener('change', renderAll);
        document.getElementById('filterStatus').addEventListener('change', renderAll);
        document.getElementById('searchInput').addEventListener('input', renderAll);

        // View toggle buttons
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                renderAll();
            });
        });

        // Initialize
        loadExcelFile();
    </script>
</body>
</html>
